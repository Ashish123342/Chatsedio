<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CallingApp — Google Sign-In + Voice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --primary: #666DC7;
  --primary-dark: #666DC7;
  --muted: linear-gradient(135deg, #eef2ff 0%, #f9fafb 100%);
  --card-bg: rgba(255,255,255,0.88);
  --card-blur: blur(8px);
  --danger: #ef4444;
  --success: #22c55e;
  --shadow: 0 10px 36px rgba(31,38,135,0.09);
  --radius: 12px;
  --font: 'Inter', Arial, Helvetica, sans-serif;
}
body {
  margin:0; min-height:100vh; font-family: var(--font);
  background: var(--muted);
  display: flex;
  flex-direction: column;
}
.panel {
  background: var(--card-bg);
  backdrop-filter: var(--card-blur);
  box-shadow: var(--shadow);
  border-radius: var(--radius);
  padding: 16px;
  margin: 8px;
}
.hidden { display: none !important; }
.app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom:12px; }
button { cursor:pointer; padding:8px 12px; border:none; border-radius:6px; background: var(--primary); color:#fff; }
.small { font-size:0.85em; }
</style>
</head>
<body>

<div id="app-container" style="display:flex; flex-direction:row; height:100vh;">
  <!-- LEFT PANEL -->
  <div class="panel" style="flex:0.9; min-width:300px;">
    <header class="app-header">
      <h3>Tsedio</h3>
      <div id="auth-controls">
        <span id="user-display" class="small"></span>
        <button id="btn-logout" class="hidden" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- LOGIN VIEW -->
    <div id="auth-view">
      <h3>Sign in</h3>
      <div class="row">
        <button onclick="googleSignIn()">Sign in with Google</button>
      </div>
      <div id="auth-error" class="small" style="color:#c00"></div>
    </div>

    <!-- PROFILE SETUP -->
    <div id="profile-setup" class="hidden">
      <h3>Set your profile</h3>
      <input id="profile-name" placeholder="Your name" /><br><br>
      <button onclick="saveProfile()">Save Profile</button>
    </div>

    <!-- MAIN LEFT (contacts, requests) -->
    <div id="main-left" class="hidden">
      <h4>Contacts / Friends</h4>
      <div id="contacts-list"></div>
      <h4>Friend Requests</h4>
      <div id="requests-list"></div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel" style="flex:1.6;">
    <div id="chat-controls" class="hidden">
      <input id="chat-input" placeholder="Type message..." style="width:70%" />
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="chat-area" class="hidden" style="margin-top:12px; height:70%; overflow:auto; border:1px solid #ccc; padding:8px;"></div>
    <div id="webrtc-ui" class="hidden"> <!-- Call buttons/UI --></div>
    <div id="incoming-call" class="hidden"></div>
    <div id="system-log" style="margin-top:12px;" class="small"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get, child, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDTjjxt12p-0CMeey4EjKqiWAz9trGB0kQ",
  authDomain: "tsedio-a122c.firebaseapp.com",
  databaseURL: "https://tsedio-a122c-default-rtdb.firebaseio.com",
  projectId: "tsedio-a122c",
  storageBucket: "tsedio-a122c.appspot.com",
  messagingSenderId: "44533653921",
  appId: "1:44533653921:web:07676dce93af9690136be0",
  measurementId: "G-ZFZG6MBV1X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt:"select_account" });

let currentUser = null;
let myProfile = null;

const $ = id => document.getElementById(id);
function log(msg){ const el=$('system-log'); el.innerText = (new Date()).toLocaleTimeString()+" — "+msg+"\n"+el.innerText; }

// Google Sign-In (Redirect)
window.googleSignIn = async ()=>{
  try { await signInWithRedirect(auth, provider); }
  catch(e){ $('auth-error').innerText = e.message || e.toString(); }
};

// Handle redirect result
getRedirectResult(auth).then(result=>{
  if(result && result.user) log("Redirect login success: "+result.user.displayName);
}).catch(e=>{ $('auth-error').innerText = e.message || e.toString(); });

// Logout
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};

// Auth listener
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser=user;
    $('user-display').innerText = user.displayName || user.email || user.uid;
    $('btn-logout').classList.remove('hidden');
    $('auth-view').classList.add('hidden');

    const profSnap = await get(child(ref(db), `profiles/${user.uid}`));
    if(!profSnap.exists()){
      $('profile-setup').classList.remove('hidden');
      $('profile-name').value = user.displayName || '';
    } else {
      myProfile = profSnap.val();
      initMainUI();
    }
  } else {
    currentUser=null; myProfile=null;
    $('user-display').innerText="";
    $('btn-logout').classList.add('hidden');
    $('auth-view').classList.remove('hidden');
    $('main-left').classList.add('hidden');
    $('chat-controls').classList.add('hidden');
    $('chat-area').classList.add('hidden');
  }
});

// Save profile
window.saveProfile = async ()=>{
  if(!currentUser) return;
  const name = $('profile-name').value.trim();
  if(!name) return alert("Enter a name");
  await set(ref(db, `profiles/${currentUser.uid}`), { name });
  myProfile = { name };
  $('profile-setup').classList.add('hidden');
  initMainUI();
};

// Init main UI
function initMainUI(){
  $('main-left').classList.remove('hidden');
  $('chat-controls').classList.remove('hidden');
  $('chat-area').classList.remove('hidden');
  attachContactsListener();
}

// Contacts listener (demo)
function attachContactsListener(){
  const contactsRef = ref(db, 'profiles');
  onChildAdded(contactsRef, snap=>{
    const data = snap.val();
    if(snap.key !== currentUser.uid){
      const el = document.createElement('div');
      el.innerText = data.name || snap.key;
      $('contacts-list').appendChild(el);
    }
  });
}

// Chat message
window.sendMessage = async ()=>{
  const msg = $('chat-input').value.trim();
  if(!msg) return;
  const chatRef = ref(db, 'chats');
  await push(chatRef, { uid:currentUser.uid, name:myProfile.name, text:msg, ts:Date.now() });
  $('chat-input').value="";
};

// Listen chat messages
const chatRef = ref(db, 'chats');
onChildAdded(chatRef, snap=>{
  const data = snap.val();
  const el = document.createElement('div');
  el.innerText = `${data.name}: ${data.text}`;
  $('chat-area').appendChild(el);
  $('chat-area').scrollTop = $('chat-area').scrollHeight;
});

</script>
</body>
</html>