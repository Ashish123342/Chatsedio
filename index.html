<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Tsedio — Friends + Chat (Anonymous)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:linear-gradient(180deg,#f8fafc,#eef2ff);--card:#fff;--primary:#4f46e5;--muted:#6b7280;--radius:12px;}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#111}
.wrap{display:flex;gap:12px;padding:16px;height:100vh}
.left{flex:0.95;min-width:320px}
.right{flex:1.6}
.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 36px rgba(31,38,135,0.06);margin-bottom:12px}
.h3{margin:0 0 8px 0}
.small{font-size:0.9rem;color:var(--muted)}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid #eaeefb}
.btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn-outline{background:#eef2ff;border:none;color:var(--primary);padding:8px 10px;border-radius:10px;cursor:pointer}
.contact{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid #f1f5f9;margin-bottom:8px}
.chat-box{height:40vh;overflow:auto;border-radius:10px;padding:12px;background:#fbfbff;border:1px solid #eef2ff}
.message{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:70%}
.me{background:#d1fae5;margin-left:auto}
.them{background:#fff;border:1px solid #eee}
.modal{position:fixed;left:50%;top:15%;transform:translateX(-50%);background:#fff;padding:16px;border-radius:10px;box-shadow:0 16px 40px rgba(0,0,0,0.12);z-index:999}
.log{font-family:monospace;font-size:0.85rem;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <div class="card header">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 class="h3">Tsedio</h2>
        <div id="auth-info" class="small"></div>
      </div>
    </div>

    <div class="card" id="profile-card" style="display:none">
      <h3 class="h3">My Profile</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <div id="p-name" style="font-weight:600;"></div>
          <div class="small" style="margin-top:6px">UID: <span id="p-uid" style="word-break:break-all"></span></div>
        </div>
        <div style="margin-left:auto;display:flex;flex-direction:column;gap:8px">
          <button class="btn-outline" onclick="copyUID()">Copy UID</button>
          <button class="btn-outline" onclick="showEdit()">Edit</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:8px 0">Add friend by UID</h4>
        <input id="add-uid" class="input" placeholder="Paste friend's UID"/>
        <div style="height:8px"></div>
        <button class="btn" onclick="sendFriendRequest()">Send Request</button>
        <div id="send-result" class="small" style="margin-top:8px;color:green"></div>
      </div>
    </div>

    <div class="card" id="auth-card">
      <div id="setup-view">
        <h3 class="h3">Enter your display name</h3>
        <input id="setup-name" class="input" placeholder="Your name"/>
        <div style="height:8px"></div>
        <button class="btn" onclick="saveProfile()">Save</button>
        <div id="auth-msg" class="small" style="margin-top:8px;color:#c00"></div>
        <div class="small" style="margin-top:8px">App signs in anonymously in background — refresh-safe.</div>
      </div>
      <div id="edit-view" style="display:none">
        <h3 class="h3">Edit name</h3>
        <input id="edit-name" class="input"/>
        <div style="height:8px"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveEdit()">Save</button>
          <button class="btn-outline" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="card" id="requests-card" style="display:none">
      <h3 class="h3">Friend Requests</h3>
      <div id="requests-list"></div>
      <div id="no-requests" class="small">No requests</div>
    </div>
  </div>

  <div class="right">
    <div class="card" id="contacts-card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 class="h3">Contacts</h3>
        <div>
          <button class="btn-outline" onclick="refreshContacts()">Refresh</button>
          <button class="btn-outline" onclick="openRequests()">Requests</button>
        </div>
      </div>
      <div id="contacts-list" style="margin-top:12px"></div>
      <div id="no-contacts" class="small">No contacts yet</div>
    </div>

    <div class="card" id="chat-card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 id="chat-title" class="h3">Chat</h3>
          <div class="small" id="chat-uid"></div>
        </div>
      </div>

      <div class="chat-box" id="chat-box"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chat-input" class="input" placeholder="Type message..." />
        <button class="btn" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <div class="card">
      <h4 class="h3">System log</h4>
      <div id="system-log" class="log" style="height:14vh;overflow:auto"></div>
    </div>
  </div>
</div>

<div id="incoming-modal" class="modal" style="display:none">
  <h4 id="incoming-title">Incoming call</h4>
  <div style="margin-top:8px">
    <button class="btn" onclick="acceptIncoming()">Accept</button>
    <button class="btn-outline" onclick="declineIncoming()">Decline</button>
  </div>
</div>

<script type="module">
/* Firebase imports (modular) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getDatabase, ref, set, get, onChildAdded, onValue, push, remove, child
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ====== Change config if needed ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDTjjxt12p-0CMeey4EjKqiWAz9trGB0kQ",
  authDomain: "tsedio-a122c.firebaseapp.com",
  databaseURL: "https://tsedio-a122c-default-rtdb.firebaseio.com",
  projectId: "tsedio-a122c",
  storageBucket: "tsedio-a122c.appspot.com",
  messagingSenderId: "44533653921",
  appId: "1:44533653921:web:07676dce93af9690136be0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ====== App state ====== */
let firebaseUser = null;   // firebase auth user
let me = null;             // my profile { uid, name }
let currentChatPeer = null; // uid of chat peer
let currentChatUnsubscriber = null; // Unsubscribe function for the chat listener

/* ====== Helpers ====== */
const $ = id => document.getElementById(id);
function log(msg){
  const el = $('system-log');
  el.innerText = (new Date()).toLocaleTimeString() + " — " + msg + "\n" + el.innerText;
}

/* ====== Anonymous sign-in ====== */
signInAnonymously(auth).catch(e=> {
  log("Sign-in error: " + (e.code||"") + " " + (e.message||""));
  $('auth-msg').innerText = "Sign-in failed: " + (e.message||e.code||'');
});

onAuthStateChanged(auth, async user => {
  if(user){
    firebaseUser = user;
    log("Signed in: " + user.uid);
    $('auth-info').innerText = "UID: " + user.uid;
    // check profile
    const profSnap = await get(child(ref(db), `profiles/${user.uid}`));
    if(profSnap.exists()){
      me = profSnap.val();
      initAfterProfile();
    } else {
      // show setup UI
      $('profile-card').style.display = 'none';
      $('requests-card').style.display = 'none';
      $('contacts-card').style.display = 'none';
      $('auth-card').style.display = 'block';
    }
  } else {
    log("Signed out");
  }
});

/* ====== Save profile (first time) ====== */
window.saveProfile = async () => {
  const name = $('setup-name').value.trim();
  if(!name) { $('auth-msg').innerText = "Enter name"; return; }
  const uid = firebaseUser.uid;
  me = { uid, name };
  await set(ref(db, `profiles/${uid}`), me);
  log("Profile saved: " + name);
  initAfterProfile();
};

/* ====== Edit profile functions ====== */
window.showEdit = () => {
  $('auth-card').style.display = 'block';
  $('setup-view').style.display = 'none';
  $('edit-view').style.display = 'block';
  $('edit-name').value = me.name;
};
window.saveEdit = async () => {
  const newName = $('edit-name').value.trim();
  if(!newName) return alert("Enter a name");
  await set(ref(db, `profiles/${me.uid}/name`), newName); // simple set
  me.name = newName;
  $('p-name').innerText = me.name;
  $('edit-view').style.display = 'none';
  $('auth-card').style.display = 'none';
};
window.cancelEdit = () => {
  $('edit-view').style.display = 'none';
  $('setup-view').style.display = 'none';
  $('auth-card').style.display = 'none';
};

/* ====== After profile is ready ====== */
function initAfterProfile(){
  // show profile & lists
  $('auth-card').style.display = 'none';
  $('profile-card').style.display = 'block';
  $('requests-card').style.display = 'block';
  $('contacts-card').style.display = 'block';
  $('p-name').innerText = me.name;
  $('p-uid').innerText = me.uid;
  $('auth-info').innerText = me.name + " • " + me.uid;
  attachRequestsListener();
  attachContactsListener();
}

/* ====== Copy UID ====== */
window.copyUID = async ()=> {
  try{ await navigator.clipboard.writeText(me.uid); alert("UID copied: " + me.uid); } catch(e){ prompt("Copy UID:", me.uid); }
};

/* ====== Friend request send ====== */
window.sendFriendRequest = async () => {
  const target = $('add-uid').value.trim();
  if(!target){ $('send-result').innerText = "Enter UID"; return; }
  if(target === me.uid){ $('send-result').innerText = "Can't add yourself"; setTimeout(()=>$('send-result').innerText='',2000); return; }

  // check target exists
  const profSnap = await get(ref(db, `profiles/${target}`));
  if(!profSnap.exists()){ $('send-result').innerText = "User not found"; setTimeout(()=>$('send-result').innerText='',2000); return; }

  // write request under friend_requests/{target}/{from}
  await set(ref(db, `friend_requests/${target}/${me.uid}`), { fromUid: me.uid, fromName: me.name, ts: Date.now() });
  $('send-result').innerText = "Request sent";
  setTimeout(()=>$('send-result').innerText='',2000);
  $('add-uid').value = '';
  log("Friend request sent to " + target);
};

/* ====== Incoming requests listener ====== */
function attachRequestsListener(){
  const node = ref(db, `friend_requests/${me.uid}`);
  $('requests-list').innerHTML = '';
  onChildAdded(node, snap => {
    const data = snap.val();
    if(!data) return;
    addRequestUI(data.fromUid, data.fromName);
  });
}

function addRequestUI(fromUid, fromName){
  $('no-requests').style.display = 'none';
  const list = $('requests-list');
  const el = document.createElement('div');
  el.id = 'req_' + fromUid;
  el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
  el.style.padding='10px'; el.style.marginBottom='8px'; el.style.border='1px solid #f1f5f9'; el.style.borderRadius='8px';
  el.innerHTML = `<div><strong>${fromName}</strong><div class="small" style="margin-top:4px">${fromUid}</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="acceptRequest('${fromUid}')">Accept</button>
      <button class="btn-outline" onclick="declineRequest('${fromUid}')">Decline</button>
    </div>`;
  list.prepend(el);
}

/* ====== Accept / Decline request ====== */
window.acceptRequest = async (fromUid) => {
  // get their profile
  const profSnap = await get(ref(db, `profiles/${fromUid}`));
  const name = profSnap.exists() ? profSnap.val().name : fromUid;
  // add mutual contact entries
  await set(ref(db, `contacts/${me.uid}/${fromUid}`), { uid: fromUid, name, since: Date.now() });
  await set(ref(db, `contacts/${fromUid}/${me.uid}`), { uid: me.uid, name: me.name, since: Date.now() });
  // remove request node
  await remove(ref(db, `friend_requests/${me.uid}/${fromUid}`));
  const el = $('req_' + fromUid);
  if(el) el.remove();
  log("Accepted friend: " + fromUid);
};

window.declineRequest = async (fromUid) => {
  await remove(ref(db, `friend_requests/${me.uid}/${fromUid}`));
  const el = $('req_' + fromUid);
  if(el) el.remove();
  log("Declined request: " + fromUid);
};

window.openRequests = ()=> { document.querySelector('#requests-card').scrollIntoView({behavior:'smooth'}); };

/* ====== Contacts (real-time) ====== */
function attachContactsListener(){
  const node = ref(db, `contacts/${me.uid}`);
  $('contacts-list').innerHTML = '';
  onChildAdded(node, snap => {
    const data = snap.val();
    if(!data) return;
    addContactUI(data.uid, data.name);
  });
  // load existing contacts once
  loadContactsOnce();
}

async function loadContactsOnce(){
  const snap = await get(ref(db, `contacts/${me.uid}`));
  $('contacts-list').innerHTML = '';
  if(!snap.exists()){ $('no-contacts').style.display = 'block'; return; }
  $('no-contacts').style.display = 'none';
  const val = snap.val();
  for(const k in val) addContactUI(val[k].uid, val[k].name);
}

function addContactUI(uid, name){
  const list = $('contacts-list');
  if(document.getElementById('contact_'+uid)) return;
  const el = document.createElement('div');
  el.id = 'contact_' + uid;
  el.className = 'contact';
  el.innerHTML = `<div><div style="font-weight:600">${name}</div><div class="small" style="margin-top:4px">${uid}</div></div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn-outline" onclick="openChat('${uid}','${name}')">Chat</button>
    </div>`;
  list.prepend(el);
}

/* ====== Chat ====== */
// Function to generate a unique chat ID for two users.
// It ensures the same ID is generated regardless of the user order.
function chatIdFor(a, b) {
  return [a, b].sort().join('_');
}

function openChat(peerUid, peerName) {
  // First, stop any existing chat listener to prevent duplicates.
  if (currentChatUnsubscriber) {
    currentChatUnsubscriber();
    log("Stopped previous chat listener.");
  }

  currentChatPeer = peerUid;
  $('chat-card').style.display = 'block';
  $('chat-title').innerText = 'Chat — ' + peerName;
  $('chat-uid').innerText = peerUid;
  $('chat-box').innerHTML = '';

  const id = chatIdFor(me.uid, peerUid);
  const node = ref(db, `chats/${id}`);

  // Use onChildAdded to listen for new messages.
  // Store the un-subscribe function in currentChatUnsubscriber.
  currentChatUnsubscriber = onChildAdded(node, snap => {
    const m = snap.val();
    if (!m) return;
    
    // Create the message element
    const el = document.createElement('div');
    el.className = 'message ' + (m.uid === me.uid ? 'me' : 'them');
    el.innerText = m.name + ': ' + m.text;
    
    // Append the message and scroll to the bottom
    $('chat-box').appendChild(el);
    $('chat-box').scrollTop = $('chat-box').scrollHeight;
  });

  log(`Opened chat with ${peerName}`);
}

window.sendMessage = async () => {
  const txt = $('chat-input').value.trim();
  if (!txt) return;
  if (!currentChatPeer) {
    alert("Open a chat with a contact first");
    return;
  }

  const id = chatIdFor(me.uid, currentChatPeer);
  // Use push() to add a new message with a unique key.
  await push(ref(db, `chats/${id}`), { 
    uid: me.uid, 
    name: me.name, 
    text: txt, 
    ts: Date.now() 
  });
  
  $('chat-input').value = '';
};

/* ====== Utilities ====== */
window.refreshContacts = ()=> loadContactsOnce();

/* Optionally remove profile on unload (commented out if you want persistent presence) */
/*
window.addEventListener('beforeunload', async ()=> {
  try{ await remove(ref(db, `profiles/${me.uid}`)); } catch(e){}
});
*/

</script>
</body>
</html>
