<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Tsedio â€” Voice Calling App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #666DC7;
  --primary-dark: #565BC7;
  --primary-light: #E0E2F5;
  --secondary: #FF7D50;
  --muted-bg: linear-gradient(135deg, #eef2ff 0%, #f9fafb 100%);
  --card-bg: rgba(255, 255, 255, 0.95);
  --card-blur: blur(10px);
  --danger: #ef4444;
  --success: #22c55e;
  --warning: #f59e0b;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-600: #4b5563;
  --gray-800: #1f2937;
  --shadow: 0 4px 20px rgba(31, 38, 135, 0.15);
  --shadow-lg: 0 10px 36px rgba(31, 38, 135, 0.2);
  --radius: 12px;
  --radius-sm: 8px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: var(--font);
  background: var(--muted-bg);
  display: flex;
  flex-direction: column;
  color: var(--gray-800);
  font-weight: 400;
}

.app-container {
  display: flex;
  flex-direction: row;
  height: 100vh;
  padding: 16px;
  gap: 16px;
}

/* Panel Styling */
.panel {
  background: var(--card-bg);
  backdrop-filter: var(--card-blur);
  box-shadow: var(--shadow);
  border-radius: var(--radius);
  padding: 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.left-panel {
  flex: 0.9;
  min-width: 300px;
  max-width: 380px;
}

.right-panel {
  flex: 1.6;
  display: flex;
  flex-direction: column;
}

/* Header */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--gray-200);
}

.app-header h3 {
  margin: 0;
  font-weight: 700;
  color: var(--primary);
  font-size: 1.5rem;
}

#user-display {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary);
  font-weight: 600;
}

/* Buttons */
button {
  cursor: pointer;
  padding: 10px 16px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-weight: 500;
  font-size: 0.9rem;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--secondary);
  color: white;
}

.btn-secondary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover {
  opacity: 0.9;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-success:hover {
  opacity: 0.9;
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--gray-300);
  color: var(--gray-600);
}

.btn-outline:hover {
  background: var(--gray-100);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 0.8rem;
}

.btn-icon {
  padding: 8px;
}

/* Inputs */
input, textarea {
  padding: 10px 14px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 0.95rem;
  width: 100%;
  transition: border 0.2s ease;
}

input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(102, 109, 199, 0.2);
}

/* Lists */
.contacts-section, .requests-section {
  margin-bottom: 24px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.section-header h4 {
  margin: 0;
  font-weight: 600;
  color: var(--gray-800);
  font-size: 1.1rem;
}

.contact-list, .request-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 4px;
}

.contact-item, .request-item {
  display: flex;
  align-items: center;
  padding: 12px;
  border-radius: var(--radius-sm);
  background: var(--gray-100);
  transition: background 0.2s ease;
}

.contact-item:hover, .request-item:hover {
  background: var(--gray-200);
}

.contact-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary);
  font-weight: 600;
  margin-right: 12px;
  flex-shrink: 0;
}

.contact-info {
  flex: 1;
}

.contact-name {
  font-weight: 500;
  margin-bottom: 2px;
}

.contact-status {
  font-size: 0.8rem;
  color: var(--gray-600);
}

.status-online {
  color: var(--success);
}

.status-offline {
  color: var(--gray-600);
}

.contact-actions {
  display: flex;
  gap: 6px;
}

/* Chat Area */
.chat-container {
  display: flex;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

.chat-header {
  display: flex;
  align-items: center;
  padding-bottom: 16px;
  margin-bottom: 16px;
  border-bottom: 1px solid var(--gray-200);
}

.current-chat {
  font-weight: 600;
  font-size: 1.1rem;
}

.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: var(--gray-100);
  border-radius: var(--radius);
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message {
  max-width: 75%;
  padding: 12px 16px;
  border-radius: 18px;
  position: relative;
  line-height: 1.4;
}

.message-incoming {
  align-self: flex-start;
  background: white;
  border: 1px solid var(--gray-200);
  border-bottom-left-radius: 4px;
}

.message-outgoing {
  align-self: flex-end;
  background: var(--primary-light);
  border-bottom-right-radius: 4px;
}

.message-sender {
  font-weight: 500;
  font-size: 0.8rem;
  margin-bottom: 4px;
  color: var(--gray-600);
}

.message-time {
  font-size: 0.7rem;
  color: var(--gray-600);
  text-align: right;
  margin-top: 4px;
}

.chat-controls {
  display: flex;
  gap: 12px;
}

#chat-input {
  flex: 1;
}

/* Call UI */
.webrtc-ui {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: var(--gray-100);
  border-radius: var(--radius);
  margin-top: 16px;
}

.call-controls {
  display: flex;
  gap: 16px;
  margin-top: 20px;
}

.call-button {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.call-info {
  text-align: center;
  margin-bottom: 20px;
}

.call-timer {
  font-size: 2rem;
  font-weight: 600;
  margin: 10px 0;
}

.incoming-call {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  text-align: center;
  min-width: 300px;
}

.caller-info {
  margin-bottom: 20px;
}

.call-actions {
  display: flex;
  justify-content: center;
  gap: 16px;
}

/* Overlay */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
}

/* Utility Classes */
.hidden { 
  display: none !important; 
}

.small { 
  font-size: 0.85em; 
}

.text-center {
  text-align: center;
}

.muted {
  color: var(--gray-600);
}

.divider {
  height: 1px;
  background: var(--gray-200);
  margin: 16px 0;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--gray-300);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gray-400);
}

/* Responsive */
@media (max-width: 768px) {
  .app-container {
    flex-direction: column;
    padding: 8px;
  }
  
  .left-panel, .right-panel {
    max-width: 100%;
    flex: 1;
  }
  
  .message {
    max-width: 85%;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <!-- LEFT PANEL -->
  <div class="panel left-panel">
    <header class="app-header">
      <h3><i class="fas fa-phone-alt"></i> Tsedio</h3>
      <div id="auth-controls">
        <span id="user-display" class="small"></span>
        <button id="btn-logout" class="hidden btn-outline btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </header>

    <!-- LOGIN VIEW -->
    <div id="auth-view">
      <div class="text-center">
        <div style="font-size: 3rem; color: var(--primary); margin-bottom: 16px;">
          <i class="fas fa-phone-alt"></i>
        </div>
        <h2>Welcome to Tsedio</h2>
        <p class="muted">Sign in to start making voice calls</p>
      </div>
      
      <div class="divider"></div>
      
      <div class="row" style="text-align: center;">
        <button class="btn-primary" onclick="googleSignIn()" style="width: 100%; justify-content: center;">
          <i class="fab fa-google"></i> Sign in with Google
        </button>
      </div>
      <div id="auth-error" class="small" style="color: var(--danger); margin-top: 12px;"></div>
    </div>

    <!-- PROFILE SETUP -->
    <div id="profile-setup" class="hidden">
      <h3>Set up your profile</h3>
      <p class="muted">Complete your profile to get started</p>
      
      <div style="margin: 20px 0;">
        <label for="profile-name">Display Name</label>
        <input id="profile-name" placeholder="Your name" />
      </div>
      
      <button class="btn-primary" onclick="saveProfile()" style="width: 100%;">
        <i class="fas fa-save"></i> Save Profile
      </button>
    </div>

    <!-- MAIN LEFT (contacts, requests) -->
    <div id="main-left" class="hidden">
      <div class="contacts-section">
        <div class="section-header">
          <h4>Contacts</h4>
          <button class="btn-icon btn-outline btn-sm"><i class="fas fa-plus"></i></button>
        </div>
        <div id="contacts-list" class="contact-list"></div>
      </div>
      
      <div class="requests-section">
        <div class="section-header">
          <h4>Friend Requests</h4>
        </div>
        <div id="requests-list" class="request-list"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel right-panel">
    <div id="chat-header" class="chat-header hidden">
      <div class="current-chat">Select a contact to start chatting</div>
    </div>
    
    <div id="chat-area" class="chat-area hidden"></div>
    
    <div id="chat-controls" class="chat-controls hidden">
      <input id="chat-input" placeholder="Type a message..." />
      <button class="btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send</button>
    </div>
    
    <div id="webrtc-ui" class="webrtc-ui hidden">
      <div class="call-info">
        <div id="call-status">Call in progress</div>
        <div id="call-timer" class="call-timer">00:00</div>
        <div id="call-with">With John Doe</div>
      </div>
      <div class="call-controls">
        <button class="call-button btn-danger" onclick="endCall()">
          <i class="fas fa-phone-slash"></i>
        </button>
        <button class="call-button btn-secondary" onclick="toggleMute()">
          <i class="fas fa-microphone"></i>
        </button>
      </div>
    </div>
    
    <div id="incoming-call" class="incoming-call hidden">
      <div class="caller-info">
        <div class="avatar" style="width: 60px; height: 60px; margin: 0 auto 16px;">
          <i class="fas fa-user" style="font-size: 1.5rem;"></i>
        </div>
        <h3>Incoming Call</h3>
        <p id="caller-name">John Doe</p>
      </div>
      <div class="call-actions">
        <button class="call-button btn-success" onclick="acceptCall()">
          <i class="fas fa-phone"></i>
        </button>
        <button class="call-button btn-danger" onclick="rejectCall()">
          <i class="fas fa-phone-slash"></i>
        </button>
      </div>
    </div>
    
    <div id="system-log" style="margin-top:12px;" class="small"></div>
  </div>
</div>

<div id="overlay" class="overlay hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get, child, push, onChildAdded, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDTjjxt12p-0CMeey4EjKqiWAz9trGB0kQ",
  authDomain: "tsedio-a122c.firebaseapp.com",
  databaseURL: "https://tsedio-a122c-default-rtdb.firebaseio.com",
  projectId: "tsedio-a122c",
  storageBucket: "tsedio-a122c.appspot.com",
  messagingSenderId: "44533653921",
  appId: "1:44533653921:web:07676dce93af9690136be0",
  measurementId: "G-ZFZG6MBV1X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt:"select_account" });

let currentUser = null;
let myProfile = null;
let selectedContact = null;
let callTimer = null;
let callStartTime = null;

const $ = id => document.getElementById(id);
function log(msg){ const el=$('system-log'); el.innerText = (new Date()).toLocaleTimeString()+" â€” "+msg+"\n"+el.innerText; }

// Google Sign-In (Redirect)
window.googleSignIn = async ()=>{
  try { 
    await signInWithRedirect(auth, provider); 
  }
  catch(e){ 
    $('auth-error').innerText = e.message || e.toString(); 
  }
};

// Handle redirect result
getRedirectResult(auth).then(result=>{
  if(result && result.user) log("Redirect login success: "+result.user.displayName);
}).catch(e=>{ 
  $('auth-error').innerText = e.message || e.toString(); 
});

// Logout
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};

// Auth listener
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser=user;
    $('user-display').innerHTML = `<div class="avatar">${user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase()}</div> ${user.displayName || user.email}`;
    $('btn-logout').classList.remove('hidden');
    $('auth-view').classList.add('hidden');

    const profSnap = await get(child(ref(db), `profiles/${user.uid}`));
    if(!profSnap.exists()){
      $('profile-setup').classList.remove('hidden');
      $('profile-name').value = user.displayName || '';
    } else {
      myProfile = profSnap.val();
      initMainUI();
    }
  } else {
    currentUser=null; myProfile=null;
    $('user-display').innerText="";
    $('btn-logout').classList.add('hidden');
    $('auth-view').classList.remove('hidden');
    $('main-left').classList.add('hidden');
    $('chat-controls').classList.add('hidden');
    $('chat-area').classList.add('hidden');
    $('chat-header').classList.add('hidden');
    $('profile-setup').classList.add('hidden');
  }
});

// Save profile
window.saveProfile = async ()=>{
  if(!currentUser) return;
  const name = $('profile-name').value.trim();
  if(!name) return alert("Enter a name");
  await set(ref(db, `profiles/${currentUser.uid}`), { 
    name,
    email: currentUser.email,
    createdAt: Date.now()
  });
  myProfile = { name };
  $('profile-setup').classList.add('hidden');
  initMainUI();
};

// Init main UI
function initMainUI(){
  $('main-left').classList.remove('hidden');
  $('chat-controls').classList.remove('hidden');
  $('chat-area').classList.remove('hidden');
  $('chat-header').classList.remove('hidden');
  attachContactsListener();
  setupCallListeners();
}

// Contacts listener
function attachContactsListener(){
  const contactsRef = ref(db, 'profiles');
  onChildAdded(contactsRef, snap=>{
    const data = snap.val();
    if(snap.key !== currentUser.uid){
      const contactItem = document.createElement('div');
      contactItem.className = 'contact-item';
      contactItem.innerHTML = `
        <div class="contact-avatar">${data.name ? data.name.charAt(0).toUpperCase() : 'U'}</div>
        <div class="contact-info">
          <div class="contact-name">${data.name || 'Unknown User'}</div>
          <div class="contact-status status-online">Online</div>
        </div>
        <div class="contact-actions">
          <button class="btn-icon btn-outline btn-sm" onclick="startCall('${snap.key}')">
            <i class="fas fa-phone"></i>
          </button>
          <button class="btn-icon btn-outline btn-sm" onclick="selectContact('${snap.key}', '${data.name}')">
            <i class="fas fa-comment"></i>
          </button>
        </div>
      `;
      contactItem.dataset.uid = snap.key;
      $('contacts-list').appendChild(contactItem);
    }
  });
}

// Select contact for chat
window.selectContact = (uid, name) => {
  selectedContact = { uid, name };
  $('chat-header').querySelector('.current-chat').textContent = `Chat with ${name}`;
  $('chat-area').innerHTML = '';
  loadChatMessages(uid);
};

// Load chat messages
function loadChatMessages(contactId) {
  const chatId = [currentUser.uid, contactId].sort().join('_');
  const messagesRef = ref(db, `chats/${chatId}/messages`);
  
  onChildAdded(messagesRef, snap => {
    const data = snap.val();
    addMessageToChat(data, data.uid === currentUser.uid);
  });
}

// Add message to chat UI
function addMessageToChat(message, isOutgoing = false) {
  const messageEl = document.createElement('div');
  messageEl.className = `message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
  
  const time = new Date(message.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  messageEl.innerHTML = `
    ${!isOutgoing ? `<div class="message-sender">${message.name}</div>` : ''}
    <div>${message.text}</div>
    <div class="message-time">${time}</div>
  `;
  
  $('chat-area').appendChild(messageEl);
  $('chat-area').scrollTop = $('chat-area').scrollHeight;
}

// Send message
window.sendMessage = async ()=>{
  if (!selectedContact) {
    alert("Please select a contact first");
    return;
  }
  
  const msg = $('chat-input').value.trim();
  if(!msg) return;
  
  const chatId = [currentUser.uid, selectedContact.uid].sort().join('_');
  const messagesRef = ref(db, `chats/${chatId}/messages`);
  
  await push(messagesRef, { 
    uid: currentUser.uid, 
    name: myProfile.name, 
    text: msg, 
    ts: Date.now() 
  });
  
  $('chat-input').value = "";
};

// Setup call listeners
function setupCallListeners() {
  // Listen for incoming calls
  const callsRef = ref(db, `calls/${currentUser.uid}`);
  onValue(callsRef, (snap) => {
    const callData = snap.val();
    if (callData && callData.status === 'ringing') {
      showIncomingCall(callData);
    }
  });
}

// Show incoming call UI
function showIncomingCall(callData) {
  $('#caller-name').textContent = callData.callerName || 'Unknown';
  $('#incoming-call').classList.remove('hidden');
  $('#overlay').classList.remove('hidden');
}

// Start a call
window.startCall = (contactId) => {
  log(`Starting call with ${contactId}`);
  // In a real app, this would set up WebRTC and send call invitation
  $('#webrtc-ui').classList.remove('hidden');
  startCallTimer();
};

// Accept incoming call
window.acceptCall = () => {
  log('Call accepted');
  $('#incoming-call').classList.add('hidden');
  $('#overlay').classList.add('hidden');
  $('#webrtc-ui').classList.remove('hidden');
  startCallTimer();
};

// Reject incoming call
window.rejectCall = () => {
  log('Call rejected');
  $('#incoming-call').classList.add('hidden');
  $('#overlay').classList.add('hidden');
};

// End current call
window.endCall = () => {
  log('Call ended');
  $('#webrtc-ui').classList.add('hidden');
  stopCallTimer();
};

// Toggle microphone mute
window.toggleMute = () => {
  log('Microphone toggled');
  // This would toggle audio track in a real app
};

// Start call timer
function startCallTimer() {
  callStartTime = new Date();
  callTimer = setInterval(() => {
    const now = new Date();
    const diff = now - callStartTime;
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    $('#call-timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

// Stop call timer
function stopCallTimer() {
  if (callTimer) {
    clearInterval(callTimer);
    callTimer = null;
  }
  $('#call-timer').textContent = '00:00';
}

// Initialize with some demo contacts if none exist
setTimeout(() => {
  if ($('contacts-list').children.length === 0 && currentUser) {
    // Add some demo contacts
    const demoContacts = [
      { id: 'demo1', name: 'Alex Johnson' },
      { id: 'demo2', name: 'Maria Garcia' },
      { id: 'demo3', name: 'David Smith' }
    ];
    
    demoContacts.forEach(contact => {
      const contactItem = document.createElement('div');
      contactItem.className = 'contact-item';
      contactItem.innerHTML = `
        <div class="contact-avatar">${contact.name.charAt(0)}</div>
        <div class="contact-info">
          <div class="contact-name">${contact.name}</div>
          <div class="contact-status status-online">Online</div>
        </div>
        <div class="contact-actions">
          <button class="btn-icon btn-outline btn-sm" onclick="startCall('${contact.id}')">
            <i class="fas fa-phone"></i>
          </button>
          <button class="btn-icon btn-outline btn-sm" onclick="selectContact('${contact.id}', '${contact.name}')">
            <i class="fas fa-comment"></i>
          </button>
        </div>
      `;
      contactItem.dataset.uid = contact.id;
      $('contacts-list').appendChild(contactItem);
    });
    
    // Add some demo messages if chat is empty
    if ($('chat-area').children.length === 0) {
      const demoMessages = [
        { text: 'Hey there! Welcome to Tsedio.', outgoing: false, time: '10:30 AM', sender: 'Alex Johnson' },
        { text: 'Thanks! This looks great.', outgoing: true, time: '10:32 AM' },
        { text: 'You can make voice calls by clicking the phone icon.', outgoing: false, time: '10:33 AM', sender: 'Alex Johnson' }
      ];
      
      demoMessages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${msg.outgoing ? 'message-outgoing' : 'message-incoming'}`;
        
        messageEl.innerHTML = `
          ${!msg.outgoing ? `<div class="message-sender">${msg.sender}</div>` : ''}
          <div>${msg.text}</div>
          <div class="message-time">${msg.time}</div>
        `;
        
        $('chat-area').appendChild(messageEl);
      });
      
      $('chat-area').scrollTop = $('chat-area').scrollHeight;
    }
  }
}, 1000);

</script>
</body>
</html>