<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Chat + Call App (Anonymous)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root {
  --primary: #666DC7;
  --primary-dark: #585FC1;
  --muted: linear-gradient(135deg, #eef2ff 0%, #f9fafb 100%);
  --card-bg: rgba(255,255,255,0.9);
  --card-blur: blur(6px);
}
body {
  margin:0; font-family: system-ui, sans-serif; background:var(--muted); color:#111;
  display:flex; justify-content:center; align-items:center; height:100vh;
}
#app {
  width:100%; max-width:500px; height:90vh; background:var(--card-bg);
  backdrop-filter:var(--card-blur); border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,0.1);
  display:flex; flex-direction:column; overflow:hidden;
}
header { padding:12px; background:var(--primary); color:#fff; text-align:center; font-weight:bold; font-size:18px; }
#user-info { padding:10px; font-size:16px; text-align:center; background:#f3f4f6; }
#tabs { display:flex; }
#tabs button {
 flex:1; padding:12px; border:none; background:#e5e7eb; cursor:pointer;
 font-weight:500; font-size:15px;
}
#tabs button.active { background:var(--primary); color:#fff; }
.view { flex:1; overflow-y:auto; display:none; padding:10px; }
.view.active { display:block; }
.user-item, .friend-item, .chat-item {
 padding:10px; margin:6px 0; background:#fff; border-radius:8px; display:flex;
 justify-content:space-between; align-items:center; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.05);
 font-size:15px;
}
.user-item button, .friend-item button, .chat-item button {
 margin-left:4px; border:none; background:var(--primary); color:#fff;
 border-radius:6px; padding:5px 9px; cursor:pointer; font-size:13px;
}
#chat-box { display:flex; flex-direction:column; height:100%; }
#messages { flex:1; overflow-y:auto; padding:10px; font-size:16px; display:flex; flex-direction:column; }
.msg-container { display:flex; margin:6px 0; }
.msg-container.me { justify-content:flex-end; }
.msg-container.other { justify-content:flex-start; }
.msg { max-width:70%; padding:10px 14px; border-radius:16px; word-wrap:break-word; position:relative; font-size:16px; }
.msg.me { background:var(--primary); color:#fff; border-bottom-right-radius:4px; }
.msg.other { background:#e5e7eb; border-bottom-left-radius:4px; }
.msg-time { font-size:11px; color:#777; text-align:right; margin-top:4px; }
#send-box { display:flex; padding:10px; background:#f0f0f0; }
#send-box input { flex:1; padding:12px; border:1px solid #ddd; border-radius:20px; font-size:16px; outline:none; }
#send-box button { margin-left:8px; background:var(--primary); color:#fff; border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; }
#call-overlay {
 position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7);
 display:none; justify-content:center; align-items:center; flex-direction:column; color:#fff;
}
#call-overlay button {
 margin:6px; padding:10px 16px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px;
}
#localVideo, #remoteVideo { width:40%; background:#000; margin:6px; }
#auth-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--muted);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 100;
}
#auth-container {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  text-align: center;
}
#auth-container h2 {
  margin-top: 0;
  color: var(--primary);
}
#auth-container input {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  box-sizing: border-box;
}
#auth-container button {
  width: 100%;
  padding: 12px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin-top: 10px;
}
#error-message {
  color: red;
  margin: 10px 0;
  min-height: 20px;
}
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div id="auth-screen">
  <div id="auth-container">
    <h2>Welcome to Chat App</h2>
    <p>Enter your name to get started</p>
    <input type="text" id="name-input" placeholder="Your name" />
    <div id="error-message"></div>
    <button id="signin-btn">Sign In Anonymously</button>
    <div id="auth-status"></div>
  </div>
</div>

<div id="app" style="display:none;">
  <header>üìû Chat + Call App</header>
  <div id="user-info">Signing in...</div>
  <div id="tabs">
    <button data-view="people" class="active">People</button>
    <button data-view="friends">Friends</button>
    <button data-view="chats">Chats</button>
  </div>
  <div id="people" class="view active"></div>
  <div id="friends" class="view"></div>
  <div id="chats" class="view"></div>
</div>

<div id="chat-box" style="display:none;">
  <header id="chat-header" style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--primary); color:#fff;">
    <span id="back-btn" style="cursor:pointer;">‚Üê</span>
    <span id="chat-with-name"></span>
    <span style="width:24px;"></span>
  </header>
  <div id="messages"></div>
  <div id="send-box">
    <input id="msgInput" placeholder="Type a message..." />
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<div id="call-overlay">
  <h2 id="call-status">Calling...</h2>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay playsinline muted></video>
  <div>
    <button id="answerBtn" style="background:green;">Answer</button>
    <button id="rejectBtn" style="background:red;">Reject</button>
    <button id="endBtn" style="background:red; display:none;">End</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, get, onChildAdded, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// üîπ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDTjjxt12p-0CMeey4EjKqiWAz9trGB0kQ",
  authDomain: "tsedio-a122c.firebaseapp.com",
  databaseURL: "https://tsedio-a122c-default-rtdb.firebaseio.com",
  projectId: "tsedio-a122c",
  storageBucket: "tsedio-a122c.firebasestorage.app",
  messagingSenderId: "44533653921",
  appId: "1:44533653921:web:07676dce93af9690136be0",
  measurementId: "G-ZFZG6MBV1X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let userName = null;
let chatWith = null;
let chatWithName = null;
let pc = null, localStream;

// Authentication flow
document.getElementById('signin-btn').addEventListener('click', async () => {
  const nameInput = document.getElementById('name-input').value.trim();
  const errorElement = document.getElementById('error-message');
  const authStatus = document.getElementById('auth-status');
  
  if (!nameInput) {
    errorElement.textContent = 'Please enter your name';
    return;
  }
  
  errorElement.textContent = '';
  authStatus.innerHTML = '<div class="loader"></div><p>Signing in...</p>';
  document.getElementById('signin-btn').disabled = true;
  
  try {
    // Try to sign in anonymously
    const userCredential = await signInAnonymously(auth);
    userName = nameInput;
    
    // Store user data in Firebase
    await set(ref(db, `users/${userCredential.user.uid}`), {
      uid: userCredential.user.uid,
      name: userName,
      online: true
    });
    
    // Hide auth screen and show app
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('user-info').textContent = `Name: ${userName}`;
    
  } catch (error) {
    console.error('Authentication error:', error);
    errorElement.textContent = `Sign in failed: ${error.message}`;
    authStatus.innerHTML = '';
    document.getElementById('signin-btn').disabled = false;
  }
});

// Handle auth state changes
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    
    // If we don't have a username yet, try to get it from the database
    if (!userName) {
      try {
        const userSnapshot = await get(ref(db, `users/${user.uid}`));
        if (userSnapshot.exists()) {
          const userData = userSnapshot.val();
          userName = userData.name;
          document.getElementById('user-info').textContent = `Name: ${userName}`;
        }
      } catch (error) {
        console.error('Error getting user data:', error);
      }
    }
    
    // Load app data
    loadPeople();
    listenRequests();
    listenChats();
    listenCalls();
  } else {
    // User is signed out - show auth screen
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    document.getElementById('signin-btn').disabled = false;
    document.getElementById('auth-status').innerHTML = '';
  }
});

// üîπ Tabs
Array.from(document.querySelectorAll('#tabs button')).forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(btn.dataset.view).classList.add('active');
  }
});

// üîπ People List
function loadPeople(){
  onChildAdded(ref(db,"users"), snap=>{
    const u = snap.val();
    if(u.uid === currentUser.uid) return;
    
    const div = document.createElement("div");
    div.className = "user-item";
    div.innerHTML = `<span>${u.name || u.uid}</span><button>Add</button>`;
    div.querySelector("button").onclick = () => sendRequest(u.uid);
    document.getElementById("people").appendChild(div);
  });
}

function sendRequest(to){
  set(ref(db,`requests/${to}/${currentUser.uid}`),{ 
    from: currentUser.uid,
    fromName: userName
  });
  alert("Request sent");
}

// üîπ Friend Requests + Friends
function listenRequests(){
  onChildAdded(ref(db,`requests/${currentUser.uid}`), snap=>{
    const r = snap.val();
    const div = document.createElement("div");
    div.className = "friend-item";
    div.innerHTML = `Request from ${r.fromName || r.from}<button>Accept</button><button>Reject</button>`;
    div.querySelectorAll("button")[0].onclick = () => {
      set(ref(db,`friends/${currentUser.uid}/${r.from}`),{ 
        uid: r.from,
        name: r.fromName
      });
      set(ref(db,`friends/${r.from}/${currentUser.uid}`),{ 
        uid: currentUser.uid,
        name: userName
      });
      remove(ref(db,`requests/${currentUser.uid}/${r.from}`));
      alert("Accepted");
    };
    div.querySelectorAll("button")[1].onclick = () => remove(ref(db,`requests/${currentUser.uid}/${r.from}`));
    document.getElementById("friends").appendChild(div);
  });
}

// üîπ Chats
function listenChats(){
  onChildAdded(ref(db,`friends/${currentUser.uid}`), snap=>{
    const f = snap.val();
    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerHTML = `Friend: ${f.name || f.uid}<button>Chat</button><button>Call</button>`;
    div.querySelector("button").onclick = () => openChat(f.uid, f.name);
    div.querySelectorAll("button")[1].onclick = () => startCall(f.uid);
    document.getElementById("chats").appendChild(div);
  });
}

function openChat(uid, friendName){
  chatWith = uid;
  chatWithName = friendName;
  document.getElementById("app").style.display = "none";
  document.getElementById("chat-box").style.display = "flex";
  document.getElementById("chat-with-name").innerText = friendName || uid;
  const msgDiv = document.getElementById("messages");
  msgDiv.innerHTML = "";
  
  onChildAdded(ref(db,`messages/${chatWith}/${currentUser.uid}`), snap=>{
    const m = snap.val();
    addMsg(m.text, "other", m.timestamp);
  });
  
  onChildAdded(ref(db,`messages/${currentUser.uid}/${chatWith}`), snap=>{
    const m = snap.val();
    addMsg(m.text, "me", m.timestamp, snap.key);
  });
}

function formatTime(timestamp) {
  if (!timestamp) return "";
  const date = new Date(timestamp);
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addMsg(text, cls, timestamp, key){
  const container = document.createElement("div");
  container.className = "msg-container " + cls;
  
  const msgDiv = document.createElement("div");
  msgDiv.className = "msg " + cls;
  msgDiv.innerText = text;
  
  const timeDiv = document.createElement("div");
  timeDiv.className = "msg-time";
  timeDiv.innerText = formatTime(timestamp);
  
  msgDiv.appendChild(timeDiv);
  container.appendChild(msgDiv);
  
  if(cls === "me" && key){
    let pressTimer;
    container.onmousedown = () => {
      pressTimer = setTimeout(() => {
        remove(ref(db,`messages/${currentUser.uid}/${chatWith}/${key}`));
        container.remove();
      }, 800); // long press 800ms
    };
    container.onmouseup = () => clearTimeout(pressTimer);
    container.onmouseleave = () => clearTimeout(pressTimer);
  }
  
  document.getElementById("messages").appendChild(container);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

document.getElementById("sendBtn").onclick = () => {
  const val = document.getElementById("msgInput").value;
  if(!val) return;
  push(ref(db,`messages/${currentUser.uid}/${chatWith}`),{ 
    text: val,
    timestamp: Date.now()
  });
  document.getElementById("msgInput").value = "";
};

// Back button functionality
document.getElementById("back-btn").onclick = () => {
  document.getElementById("chat-box").style.display = "none";
  document.getElementById("app").style.display = "flex";
};

// üîπ WebRTC Calls
async function startCall(to){
  document.getElementById("call-overlay").style.display = "flex";
  document.getElementById("call-status").innerText = "Calling " + to;
  document.getElementById("answerBtn").style.display = "none";
  document.getElementById("rejectBtn").style.display = "none";
  document.getElementById("endBtn").style.display = "block";
  
  pc = new RTCPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  document.getElementById("localVideo").srcObject = localStream;
  
  pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];
  pc.onicecandidate = e => { 
    if(e.candidate) push(ref(db,`calls/${to}`),{ 
      from: currentUser.uid,
      fromName: userName,
      candidate: e.candidate 
    }); 
  };
  
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  push(ref(db,`calls/${to}`),{ 
    from: currentUser.uid,
    fromName: userName,
    offer 
  });
}

function listenCalls(){
  onChildAdded(ref(db,`calls/${currentUser.uid}`), async snap=>{
    const c = snap.val();
    if(c.offer){
      pc = new RTCPeerConnection();
      localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      document.getElementById("localVideo").srcObject = localStream;
      
      pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];
      pc.onicecandidate = e => { 
        if(e.candidate) push(ref(db,`calls/${c.from}`),{ 
          from: currentUser.uid,
          fromName: userName,
          candidate: e.candidate 
        }); 
      };
      
      await pc.setRemoteDescription(new RTCSessionDescription(c.offer));
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      push(ref(db,`calls/${c.from}`),{ 
        from: currentUser.uid,
        fromName: userName,
        answer: ans 
      });
      
      document.getElementById("call-overlay").style.display = "flex";
      document.getElementById("call-status").innerText = `Incoming Call from ${c.fromName || c.from}`;
      document.getElementById("answerBtn").style.display = "block";
      document.getElementById("rejectBtn").style.display = "block";
      document.getElementById("endBtn").style.display = "none";
    }
    
    if(c.answer){ await pc.setRemoteDescription(new RTCSessionDescription(c.answer)); }
    if(c.candidate){ await pc.addIceCandidate(new RTCIceCandidate(c.candidate)); }
  });
}

document.getElementById("endBtn").onclick = endCall;
document.getElementById("rejectBtn").onclick = endCall;
document.getElementById("answerBtn").onclick = () => {
  document.getElementById("answerBtn").style.display = "none";
  document.getElementById("rejectBtn").style.display = "none";
  document.getElementById("endBtn").style.display = "block";
  document.getElementById("call-status").innerText = "In Call";
};

function endCall(){
  document.getElementById("call-overlay").style.display = "none";
  if(pc){ pc.close(); pc = null; }
  if(localStream){ localStream.getTracks().forEach(t => t.stop()); }
}
</script>
</body>
</html>
